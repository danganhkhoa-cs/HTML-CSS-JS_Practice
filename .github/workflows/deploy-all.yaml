name: Deploy All Projects to GitHub Pages

on:
  push:
    branches:
      - dev
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages

    steps:
      # 1. L·∫•y m√£ ngu·ªìn
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. C√†i Node.js (ƒë·ªÉ build c√°c project Vite)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3. T·ª± ƒë·ªông ph√°t hi·ªán project con c√≥ Vite, c√†i & build
      - name: Build all Vite subprojects
        shell: bash
        run: |
          set -e
          for dir in */; do
            if [ -f "${dir}package.json" ] && [ -f "${dir}vite.config.js" ]; then
              echo "‚öôÔ∏è Building Vite project in $dir"
              cd "$dir"
              npm ci || npm install
              npm run build || echo "‚ö†Ô∏è Build failed for $dir, skipping..."
              cd ..
            else
              echo "‚è© Skipping non-Vite folder: $dir"
            fi
          done

      # 4. C·∫•u h√¨nh GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v5

      # 5. Gom to√†n b·ªô project sau khi build
      - name: Collect all built projects
        shell: bash
        run: |
          set -e
          rm -rf _temp
          mkdir -p _temp
          for dir in */; do
            if [ -f "${dir}dist/index.html" ]; then
              echo "üìÅ Found built project: $dir"
              mkdir -p "_temp/$dir"
              cp -r "${dir}dist/"* "_temp/$dir"
            elif [ -f "${dir}public/index.html" ]; then
              echo "üìÅ Found static project with public/: $dir"
              mkdir -p "_temp/$dir"
              cp -r "${dir}public/"* "_temp/$dir"
            elif [ -f "${dir}index.html" ]; then
              echo "üìÅ Found static root project: $dir"
              mkdir -p "_temp/$dir"
              cp -r "${dir}"* "_temp/$dir"
            else
              echo "‚ùå No build or index.html found in $dir"
            fi
          done
          echo "‚úÖ All projects prepared in _temp."

      # 6. Upload artifact cho Pages
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _temp

      # 7. Deploy l√™n GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
